<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Liste des utilisateurs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f2f6fc;
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            max-width: 900px;
            width: 100%;
        }
        .table {
            font-size: 0.9rem;
        }
        .table th, .table td {
            text-align: center;
            padding: 8px;
        }
        .table th {
            background-color: #007bff;
            color: white;
        }
        .loading {
            display: none;
            text-align: center;
            font-size: 18px;
            color: #007bff;
        }
    </style>
</head>
<body>

<div class="container">

    <h1 class="my-4 text-center">Liste des Utilisateurs</h1>

    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Email</th>
                <th>Nom</th>
                <th>Prénom</th>
                <th>Contact</th>
                <th>Invitations</th>
            </tr>
        </thead>
        <tbody id="userList">
        </tbody>
    </table>

    <div class="d-flex justify-content-between my-4">
        <div>
            <p><strong>Total Invitations:</strong> <span id="totalInvitations">0</span></p>
            <p><strong>Invitations Restantes:</strong> <span id="remainingInvitations">0</span></p>
        </div>
        <div>
            <button class="btn btn-success" id="exportBtn">Exporter en Excel</button>
        </div>
    </div>

    <div class="pagination-container">
        <ul class="pagination" id="pagination">
        </ul>
    </div>

    <div class="loading" id="loadingMessage">Chargement en cours...</div>

</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

    const firebaseConfig = {
        apiKey: "AIzaSyApJun7s5MfXVn9NQJliHGw2XRn5pl0u3k",
        authDomain: "testcloud-7de43.firebaseapp.com",
        databaseURL: "https://testcloud-7de43-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "testcloud-7de43",
        storageBucket: "testcloud-7de43.firebasestorage.app",
        messagingSenderId: "544597566666",
        appId: "1:544597566666:web:130520e4d4aee4362ec033",
        measurementId: "G-0NXVT1C3BR"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const itemsPerPage = 10;
    let currentPage = 1;
    let users = [];

    async function fetchUsersAndEvents() {
        try {
            const loadingMessage = document.getElementById('loadingMessage');
            loadingMessage.style.display = 'block';

            const usersSnapshot = await getDocs(collection(db, 'users'));
            users = usersSnapshot.docs.map(doc => doc.data());

            let totalInvitations = 0;
            let totalRemaining = 200; 
            users.forEach(user => {
                totalInvitations += user.invitations;
                totalRemaining -= user.invitations;
            });

            document.getElementById('totalInvitations').textContent = totalInvitations;
            document.getElementById('remainingInvitations').textContent = totalRemaining;

            displayPage(currentPage);

            updatePagination();

        } catch (error) {
            console.error('Erreur lors de la récupération des données:', error);
        } finally {
            document.getElementById('loadingMessage').style.display = 'none';
        }
    }

    function displayPage(page) {
        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const usersToDisplay = users.slice(startIndex, endIndex);

        const userList = document.getElementById('userList');
        userList.innerHTML = ''; 

        usersToDisplay.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = ` 
                <td>${user.email}</td>
                <td>${user.name}</td>
                <td>${user.firstname}</td>
                <td>${user.phone}</td>
                <td>${user.invitations}</td>
            `;
            userList.appendChild(row);
        });
    }

    // Fonction pour mettre à jour la pagination
    function updatePagination() {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = ''; 

        const totalPages = Math.ceil(users.length / itemsPerPage);

        for (let i = 1; i <= totalPages; i++) {
            const pageItem = document.createElement('li');
            pageItem.classList.add('page-item');
            const pageLink = document.createElement('a');
            pageLink.classList.add('page-link');
            pageLink.href = '#';
            pageLink.textContent = i;
            pageLink.addEventListener('click', () => {
                currentPage = i;
                displayPage(currentPage);
            });
            pageItem.appendChild(pageLink);
            pagination.appendChild(pageItem);
        }
    }

    document.getElementById('exportBtn').addEventListener('click', async () => {
        const loadingMessage = document.getElementById('loadingMessage');
        loadingMessage.style.display = 'block'; 

        try {
            const response = await fetch('https://us-central1-testcloud-7de43.cloudfunctions.net/exportToExcel');
            if (response.ok) {
                const blob = await response.blob();
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'export_utilisateurs.xlsx';
                link.click();
            } else {
                console.error('Erreur lors de l\'exportation en Excel');
            }
        } catch (error) {
            console.error('Erreur de réseau ou autre :', error);
        } finally {
            loadingMessage.style.display = 'none'; 
        }
    });

    window.onload = fetchUsersAndEvents;
</script>

</body>
</html>
